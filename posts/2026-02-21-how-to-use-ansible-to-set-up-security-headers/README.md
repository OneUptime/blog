# How to Use Ansible to Set Up Security Headers

Author: [nawazdhandala](https://www.github.com/nawazdhandala)

Tags: Ansible, Security, Nginx, HTTP Headers, DevOps

Description: Automate the deployment of HTTP security headers in Nginx using Ansible to protect your web applications from XSS, clickjacking, and other attacks.

---

HTTP security headers are your first line of defense against a whole class of web attacks. Headers like Content-Security-Policy, X-Frame-Options, and Strict-Transport-Security tell the browser how to behave when loading your site, blocking many common attack vectors before they reach your application code. The problem is that these headers need to be configured identically on every web server, and forgetting even one header on one server creates a vulnerability.

Ansible makes it easy to deploy a comprehensive set of security headers across your entire infrastructure and keep them updated as your security policy evolves.

## The Security Headers We Will Configure

Here is the full set of security headers and what each one does:

| Header | Purpose |
|--------|---------|
| Content-Security-Policy | Controls which resources the browser can load |
| X-Frame-Options | Prevents clickjacking by controlling iframe embedding |
| X-Content-Type-Options | Prevents MIME type sniffing |
| X-XSS-Protection | Legacy XSS filter (for older browsers) |
| Strict-Transport-Security | Forces HTTPS connections |
| Referrer-Policy | Controls how much referrer info is sent |
| Permissions-Policy | Controls which browser features can be used |
| X-Permitted-Cross-Domain-Policies | Controls Adobe Flash/PDF cross-domain access |

## Project Structure

```
nginx-security-headers/
  inventory/
    hosts.yml
  roles/
    security_headers/
      tasks/
        main.yml
      templates/
        security_headers.conf.j2
        site_with_headers.conf.j2
      defaults/
        main.yml
      handlers/
        main.yml
  playbook.yml
```

## Default Variables

These defaults represent a strict security posture. You will likely need to relax some of these for your specific application.

```yaml
# roles/security_headers/defaults/main.yml
# Content-Security-Policy directives
nginx_csp_default_src: "'self'"
nginx_csp_script_src: "'self'"
nginx_csp_style_src: "'self' 'unsafe-inline'"
nginx_csp_img_src: "'self' data: https:"
nginx_csp_font_src: "'self'"
nginx_csp_connect_src: "'self'"
nginx_csp_frame_src: "'none'"
nginx_csp_object_src: "'none'"
nginx_csp_base_uri: "'self'"
nginx_csp_form_action: "'self'"
nginx_csp_report_uri: ""

# X-Frame-Options
nginx_x_frame_options: "DENY"

# X-Content-Type-Options
nginx_x_content_type_options: "nosniff"

# X-XSS-Protection (legacy, but still useful for IE)
nginx_x_xss_protection: "1; mode=block"

# HSTS settings
nginx_hsts_max_age: 31536000
nginx_hsts_include_subdomains: true
nginx_hsts_preload: true

# Referrer-Policy
nginx_referrer_policy: "strict-origin-when-cross-origin"

# Permissions-Policy (formerly Feature-Policy)
nginx_permissions_policy:
  camera: "()"
  microphone: "()"
  geolocation: "()"
  payment: "()"
  usb: "()"
  accelerometer: "()"
  gyroscope: "()"

# Cross-domain policies
nginx_cross_domain_policies: "none"

# Server configuration
nginx_security_server_name: "example.com"
nginx_security_backend: "127.0.0.1:3000"
nginx_ssl_enabled: true
```

## Security Headers Configuration Template

This template generates a reusable Nginx snippet with all the security headers.

```nginx
# roles/security_headers/templates/security_headers.conf.j2
# HTTP Security Headers
# Generated by Ansible - do not edit manually

# Content-Security-Policy
# Controls which resources the browser is allowed to load
{% set csp_parts = [] %}
{% set _ = csp_parts.append("default-src " + nginx_csp_default_src) %}
{% set _ = csp_parts.append("script-src " + nginx_csp_script_src) %}
{% set _ = csp_parts.append("style-src " + nginx_csp_style_src) %}
{% set _ = csp_parts.append("img-src " + nginx_csp_img_src) %}
{% set _ = csp_parts.append("font-src " + nginx_csp_font_src) %}
{% set _ = csp_parts.append("connect-src " + nginx_csp_connect_src) %}
{% set _ = csp_parts.append("frame-src " + nginx_csp_frame_src) %}
{% set _ = csp_parts.append("object-src " + nginx_csp_object_src) %}
{% set _ = csp_parts.append("base-uri " + nginx_csp_base_uri) %}
{% set _ = csp_parts.append("form-action " + nginx_csp_form_action) %}
{% if nginx_csp_report_uri %}
{% set _ = csp_parts.append("report-uri " + nginx_csp_report_uri) %}
{% endif %}
add_header Content-Security-Policy "{{ csp_parts | join('; ') }}" always;

# Prevent clickjacking
add_header X-Frame-Options "{{ nginx_x_frame_options }}" always;

# Prevent MIME type sniffing
add_header X-Content-Type-Options "{{ nginx_x_content_type_options }}" always;

# XSS protection for legacy browsers
add_header X-XSS-Protection "{{ nginx_x_xss_protection }}" always;

{% if nginx_ssl_enabled %}
# Force HTTPS via HSTS
add_header Strict-Transport-Security "max-age={{ nginx_hsts_max_age }}{% if nginx_hsts_include_subdomains %}; includeSubDomains{% endif %}{% if nginx_hsts_preload %}; preload{% endif %}" always;
{% endif %}

# Control referrer information
add_header Referrer-Policy "{{ nginx_referrer_policy }}" always;

# Restrict browser features
{% set policy_parts = [] %}
{% for feature, value in nginx_permissions_policy.items() %}
{% set _ = policy_parts.append(feature + "=" + value) %}
{% endfor %}
add_header Permissions-Policy "{{ policy_parts | join(', ') }}" always;

# Restrict cross-domain policies (Flash, PDF)
add_header X-Permitted-Cross-Domain-Policies "{{ nginx_cross_domain_policies }}" always;

# Remove server version header
server_tokens off;
```

## Site Configuration Template

```nginx
# roles/security_headers/templates/site_with_headers.conf.j2
{% if nginx_ssl_enabled %}
server {
    listen 80;
    server_name {{ nginx_security_server_name }};
    return 301 https://$host$request_uri;
}
{% endif %}

server {
{% if nginx_ssl_enabled %}
    listen 443 ssl http2;
    ssl_certificate /etc/letsencrypt/live/{{ nginx_security_server_name }}/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/{{ nginx_security_server_name }}/privkey.pem;
{% else %}
    listen 80;
{% endif %}
    server_name {{ nginx_security_server_name }};

    # Include security headers
    include /etc/nginx/snippets/security_headers.conf;

    location / {
        proxy_pass http://{{ nginx_security_backend }};
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
```

## Ansible Tasks

```yaml
# roles/security_headers/tasks/main.yml
---
- name: Install Nginx
  ansible.builtin.apt:
    name: nginx
    state: present
    update_cache: yes
  become: true

- name: Create snippets directory
  ansible.builtin.file:
    path: /etc/nginx/snippets
    state: directory
    owner: root
    group: root
    mode: "0755"
  become: true

- name: Deploy security headers snippet
  ansible.builtin.template:
    src: security_headers.conf.j2
    dest: /etc/nginx/snippets/security_headers.conf
    owner: root
    group: root
    mode: "0644"
  become: true
  notify: Validate and reload nginx

- name: Deploy site configuration
  ansible.builtin.template:
    src: site_with_headers.conf.j2
    dest: /etc/nginx/sites-available/secure_site.conf
    owner: root
    group: root
    mode: "0644"
  become: true
  notify: Validate and reload nginx

- name: Enable site
  ansible.builtin.file:
    src: /etc/nginx/sites-available/secure_site.conf
    dest: /etc/nginx/sites-enabled/secure_site.conf
    state: link
  become: true
  notify: Validate and reload nginx

- name: Remove default site
  ansible.builtin.file:
    path: /etc/nginx/sites-enabled/default
    state: absent
  become: true
  notify: Validate and reload nginx

- name: Ensure Nginx is running
  ansible.builtin.systemd:
    name: nginx
    state: started
    enabled: true
  become: true
```

## Handlers

```yaml
# roles/security_headers/handlers/main.yml
---
- name: Validate and reload nginx
  ansible.builtin.command: nginx -t
  become: true
  changed_when: false
  notify: Reload nginx

- name: Reload nginx
  ansible.builtin.systemd:
    name: nginx
    state: reloaded
  become: true
```

## The Playbook

```yaml
# playbook.yml
---
- name: Deploy security headers
  hosts: webservers
  become: true
  vars:
    nginx_security_server_name: "myapp.com"
    nginx_security_backend: "127.0.0.1:3000"
    # Allow Google Fonts in the CSP
    nginx_csp_font_src: "'self' https://fonts.gstatic.com"
    nginx_csp_style_src: "'self' 'unsafe-inline' https://fonts.googleapis.com"
    # Allow embedding in our own iframe
    nginx_x_frame_options: "SAMEORIGIN"
  roles:
    - security_headers
```

## Testing Your Headers

After deployment, check the security headers with curl:

```bash
# View all response headers
curl -I https://myapp.com

# Check specific security headers
curl -sI https://myapp.com | grep -iE "content-security|x-frame|x-content-type|strict-transport|referrer-policy|permissions-policy"
```

You can also use online tools like Mozilla Observatory or securityheaders.com to get a grade for your header configuration. The defaults in this role should give you an A or A+ rating.

## Adjusting CSP for Your Application

The Content-Security-Policy header is the most likely one you will need to customize. If your app uses Google Analytics, CDN-hosted scripts, or inline styles, you need to add those sources to the policy.

```yaml
# Allow Google Analytics and a CDN
nginx_csp_script_src: "'self' https://www.google-analytics.com https://cdn.example.com"
nginx_csp_img_src: "'self' data: https://www.google-analytics.com"
nginx_csp_connect_src: "'self' https://www.google-analytics.com"
```

Start with the strict defaults and progressively add exceptions as needed. Use the browser's developer console to identify which resources are being blocked by the CSP.

## Summary

HTTP security headers are a critical and often overlooked part of web application security. With this Ansible role, you can deploy a comprehensive set of security headers across all your servers in one command. The template approach makes it easy to adjust the policy per environment (stricter in production, more relaxed in development) while maintaining a consistent baseline. Run the playbook, check your score on Mozilla Observatory, and you will have a much more secure web application.
