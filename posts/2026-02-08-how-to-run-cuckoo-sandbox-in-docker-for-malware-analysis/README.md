# How to Run Cuckoo Sandbox in Docker for Malware Analysis

Author: [nawazdhandala](https://github.com/nawazdhandala)

Tags: docker, cuckoo sandbox, malware analysis, security, sandboxing, containerization, threat detection

Description: Deploy Cuckoo Sandbox in Docker to automate malware analysis with isolated detonation environments and detailed behavioral reports.

---

Analyzing suspicious files safely requires an isolated environment where malware can execute without harming production systems. Cuckoo Sandbox is one of the most widely used open-source malware analysis platforms. It automates the process of running suspicious files in a controlled environment and produces detailed reports on their behavior. Running Cuckoo in Docker simplifies what has traditionally been one of the most complex security tools to install.

This guide covers setting up Cuckoo Sandbox with Docker, configuring analysis VMs, submitting samples, and interpreting results.

## What Cuckoo Sandbox Does

When you submit a suspicious file to Cuckoo, it does the following:

1. Spins up an isolated virtual machine or container
2. Drops the file into the guest and executes it
3. Monitors system calls, network traffic, file system changes, and registry modifications
4. Captures screenshots and memory dumps
5. Generates a comprehensive behavioral report
6. Scores the sample based on observed malicious indicators

Analysts use these reports to understand what malware does without risking their own machines. SOC teams use Cuckoo to triage alerts by detonating suspicious email attachments and downloads.

```mermaid
graph LR
    A[Submit Sample] --> B[Cuckoo Scheduler]
    B --> C[Analysis VM/Container]
    C --> D[Monitor Behavior]
    D --> E[Network Capture]
    D --> F[API Call Tracing]
    D --> G[File System Changes]
    D --> H[Memory Dump]
    E --> I[Report Generator]
    F --> I
    G --> I
    H --> I
    I --> J[Web UI / API Results]
```

## Prerequisites

Cuckoo requires nested virtualization support for running analysis VMs inside Docker, or you can use Docker containers themselves as analysis targets (less thorough but simpler to set up).

- Docker Engine 20.10+
- Docker Compose v2
- At least 8 GB RAM (16 GB recommended)
- 100 GB free disk space for samples and reports
- KVM support on the host (for VM-based analysis)

```bash
# Check if KVM is available on your host
kvm-ok

# Or check for virtualization CPU flags
grep -c 'vmx\|svm' /proc/cpuinfo
```

## Project Setup

Create a directory structure for your Cuckoo Docker deployment.

```bash
# Create the project directory and subdirectories
mkdir -p ~/cuckoo-docker/{storage,conf,samples}
cd ~/cuckoo-docker
```

## Docker Compose Configuration

Cuckoo consists of several components: the main processing engine, a web interface, a PostgreSQL database, and MongoDB for storing reports.

```yaml
# docker-compose.yml - Cuckoo Sandbox full stack
version: "3.8"

services:
  postgres:
    image: postgres:15-alpine
    container_name: cuckoo-postgres
    environment:
      POSTGRES_DB: cuckoo
      POSTGRES_USER: cuckoo
      POSTGRES_PASSWORD: cuckoo-db-password
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      - cuckoo-net
    restart: unless-stopped

  mongodb:
    image: mongo:6
    container_name: cuckoo-mongodb
    volumes:
      # Stores analysis reports and behavioral data
      - mongo_data:/data/db
    networks:
      - cuckoo-net
    restart: unless-stopped

  cuckoo-core:
    image: blacktop/cuckoo:latest
    container_name: cuckoo-core
    depends_on:
      - postgres
      - mongodb
    privileged: true
    volumes:
      # Persistent storage for samples and results
      - ./storage:/cuckoo/storage
      # Custom configuration
      - ./conf:/cuckoo/conf
      # Docker socket for container-based analysis
      - /var/run/docker.sock:/var/run/docker.sock
    environment:
      - CUCKOO_DB=postgresql://cuckoo:cuckoo-db-password@postgres/cuckoo
      - CUCKOO_MONGODB=mongodb://mongodb:27017
    networks:
      - cuckoo-net
    restart: unless-stopped

  cuckoo-web:
    image: blacktop/cuckoo:latest
    container_name: cuckoo-web
    depends_on:
      - cuckoo-core
      - mongodb
    ports:
      # Web interface
      - "8080:8080"
    environment:
      - CUCKOO_DB=postgresql://cuckoo:cuckoo-db-password@postgres/cuckoo
      - CUCKOO_MONGODB=mongodb://mongodb:27017
    command: web
    networks:
      - cuckoo-net
    restart: unless-stopped

  cuckoo-api:
    image: blacktop/cuckoo:latest
    container_name: cuckoo-api
    depends_on:
      - cuckoo-core
    ports:
      # REST API
      - "8090:8090"
    environment:
      - CUCKOO_DB=postgresql://cuckoo:cuckoo-db-password@postgres/cuckoo
    command: api
    networks:
      - cuckoo-net
    restart: unless-stopped

volumes:
  postgres_data:
  mongo_data:

networks:
  cuckoo-net:
    driver: bridge
```

## Configuring Cuckoo

Cuckoo needs configuration files that tell it how to manage analysis environments and what to monitor.

```python
# conf/cuckoo.conf - Main Cuckoo configuration
[cuckoo]
# Maximum number of concurrent analyses
max_analysis_count = 4
# Analysis timeout in seconds
analysis_timeout = 120
# Critical timeout - force kill after this many seconds
critical_timeout = 600
# Store full memory dumps (requires more disk space)
memory_dump = off

[resultserver]
# Address the analysis guests report back to
ip = 0.0.0.0
port = 2042

[processing]
# Enable behavior analysis
analysis_size_limit = 134217728

[database]
# PostgreSQL connection (set via environment variable)
connection =
```

Create the analysis machine configuration for Docker-based analysis.

```python
# conf/docker_machine.conf - Docker-based analysis configuration
[docker]
# Docker daemon connection
endpoint = unix:///var/run/docker.sock

# Analysis container image
image = cuckoo-guest

# Network interface for the analysis container
interface = eth0

# Resource limits for analysis containers
memory_limit = 1073741824
cpu_period = 100000
cpu_quota = 50000

[docker_machine:analysis1]
label = analysis1
platform = linux
ip = 172.18.0.10
tags = linux,x64
```

## Building the Analysis Guest Image

The analysis guest is a Docker image that Cuckoo uses to detonate samples. It needs common libraries and the Cuckoo agent installed.

```dockerfile
# Dockerfile.guest - Cuckoo analysis guest container
FROM ubuntu:22.04

# Install common libraries that malware expects to find
RUN apt-get update && apt-get install -y \
    python3 \
    python3-pip \
    curl \
    wget \
    libc6-i386 \
    lib32stdc++6 \
    unzip \
    xvfb \
    && rm -rf /var/lib/apt/lists/*

# Install the Cuckoo agent
RUN pip3 install cuckoo-agent

# Create directories for sample delivery
RUN mkdir -p /tmp/cuckoo-analysis

# Run the Cuckoo agent on startup
CMD ["python3", "-m", "agent"]
```

Build the guest image.

```bash
# Build the analysis guest image
docker build -f Dockerfile.guest -t cuckoo-guest .
```

## Starting Cuckoo

```bash
# Start the full Cuckoo stack
docker compose up -d

# Check that all services are running
docker compose ps

# Watch the core service logs for initialization
docker compose logs -f cuckoo-core
```

Wait for Cuckoo to fully initialize. The web interface becomes available at `http://localhost:8080`.

## Submitting Samples for Analysis

You can submit files through the web interface or the REST API.

```bash
# Submit a file via the REST API
curl -F "file=@/path/to/suspicious-file.exe" \
  http://localhost:8090/tasks/create/file

# Submit a URL for analysis
curl -F "url=http://suspicious-site.example.com" \
  http://localhost:8090/tasks/create/url

# Submit with specific analysis options
curl -F "file=@/path/to/sample.exe" \
  -F "timeout=180" \
  -F "priority=2" \
  -F "memory=true" \
  http://localhost:8090/tasks/create/file
```

## Checking Analysis Results

```bash
# List all analysis tasks
curl http://localhost:8090/tasks/list | python3 -m json.tool

# Get the status of a specific task
curl http://localhost:8090/tasks/view/1 | python3 -m json.tool

# Download the full report for task 1
curl http://localhost:8090/tasks/report/1 -o report.json

# Get just the behavioral summary
curl http://localhost:8090/tasks/report/1/summary | python3 -m json.tool
```

## Automating Sample Submission with Python

For SOC teams that need to process many samples, automate the workflow.

```python
# submit_samples.py - Batch sample submission to Cuckoo
import os
import requests
import time

CUCKOO_API = "http://localhost:8090"
SAMPLES_DIR = "./samples"

def submit_file(filepath):
    """Submit a single file to Cuckoo for analysis."""
    with open(filepath, "rb") as f:
        response = requests.post(
            f"{CUCKOO_API}/tasks/create/file",
            files={"file": (os.path.basename(filepath), f)},
            data={"timeout": 120, "priority": 1}
        )
    if response.status_code == 200:
        task_id = response.json()["task_id"]
        print(f"Submitted {filepath} - Task ID: {task_id}")
        return task_id
    else:
        print(f"Failed to submit {filepath}: {response.text}")
        return None

def wait_for_report(task_id, timeout=600):
    """Poll until the analysis is complete."""
    start = time.time()
    while time.time() - start < timeout:
        resp = requests.get(f"{CUCKOO_API}/tasks/view/{task_id}")
        status = resp.json()["task"]["status"]
        if status == "reported":
            return True
        elif status == "failed_analysis":
            print(f"Task {task_id} failed")
            return False
        time.sleep(10)
    return False

# Submit all files in the samples directory
for filename in os.listdir(SAMPLES_DIR):
    filepath = os.path.join(SAMPLES_DIR, filename)
    if os.path.isfile(filepath):
        task_id = submit_file(filepath)
        if task_id:
            if wait_for_report(task_id):
                # Download the report
                report = requests.get(f"{CUCKOO_API}/tasks/report/{task_id}")
                score = report.json().get("info", {}).get("score", 0)
                print(f"Task {task_id} scored: {score}/10")
```

## Interpreting Reports

Cuckoo reports contain several key sections:

- **Info** - task metadata, analysis duration, score
- **Signatures** - matched behavioral signatures (e.g., "creates autorun registry key")
- **Network** - DNS queries, HTTP requests, TCP connections made by the sample
- **Dropped files** - files created or modified during execution
- **API calls** - system calls made by the sample, ordered by process

A score of 0-3 typically indicates benign or low-risk behavior. Scores of 4-7 suggest potentially unwanted programs. Scores above 7 strongly indicate malicious behavior.

## Storage Management

Malware analysis generates a lot of data. Keep your storage under control.

```bash
# Check storage usage
du -sh ./storage/*

# Delete analysis results older than 30 days
find ./storage/analyses -maxdepth 1 -type d -mtime +30 -exec rm -rf {} +

# Clean up orphaned Docker analysis containers
docker container prune -f --filter "label=cuckoo-analysis"
```

## Conclusion

Cuckoo Sandbox in Docker gives security teams automated malware analysis without the painful manual installation process. Submit suspicious files through the API or web interface, and Cuckoo handles the detonation, monitoring, and reporting. Integrate it with your email gateway to automatically analyze attachments, connect it to TheHive for case management, or feed its IOC output into MISP for threat intelligence sharing. The Docker deployment makes it practical to run malware analysis as a service for your entire security team.
