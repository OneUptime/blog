# How to Use FluxCD to Continuously Reconcile OpenTelemetry Collector Configuration from Git

Author: [nawazdhandala](https://www.github.com/nawazdhandala)

Tags: OpenTelemetry, FluxCD, GitOps, Kubernetes

Description: Set up FluxCD to continuously reconcile OpenTelemetry Collector configurations from a Git repository to your Kubernetes clusters.

FluxCD is a GitOps tool that continuously synchronizes your Kubernetes cluster state with declarations stored in Git. Unlike ArgoCD which provides a UI-centric approach, FluxCD is designed to run entirely from manifests. This makes it a natural fit for managing OpenTelemetry Collector deployments where every change must be traceable and automated.

## Setting Up FluxCD

Install Flux in your cluster:

```bash
# Install the Flux CLI
curl -s https://fluxcd.io/install.sh | sudo bash

# Bootstrap Flux with your Git repository
flux bootstrap github \
  --owner=yourorg \
  --repository=otel-infrastructure \
  --branch=main \
  --path=clusters/production \
  --personal
```

## Repository Structure

```
otel-infrastructure/
  clusters/
    production/
      flux-system/        # Auto-generated by Flux
      otel/
        namespace.yaml
        kustomization.yaml
        collector-source.yaml
    staging/
      otel/
        kustomization.yaml
  base/
    otel-collector/
      kustomization.yaml
      configmap.yaml
      daemonset.yaml
      service.yaml
      serviceaccount.yaml
  overlays/
    production/
      kustomization.yaml
      patches/
        resources.yaml
        config.yaml
    staging/
      kustomization.yaml
      patches/
        resources.yaml
```

## Base Collector Manifests

Define the base Collector resources:

```yaml
# base/otel-collector/kustomization.yaml
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
resources:
  - namespace.yaml
  - serviceaccount.yaml
  - configmap.yaml
  - daemonset.yaml
  - service.yaml
```

```yaml
# base/otel-collector/configmap.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: otel-collector-config
  namespace: observability
data:
  config.yaml: |
    receivers:
      otlp:
        protocols:
          grpc:
            endpoint: 0.0.0.0:4317
          http:
            endpoint: 0.0.0.0:4318
    processors:
      batch:
        send_batch_size: 4096
        timeout: 1s
      memory_limiter:
        check_interval: 5s
        limit_mib: 1536
    exporters:
      otlphttp:
        endpoint: https://backend:4318
    service:
      pipelines:
        traces:
          receivers: [otlp]
          processors: [memory_limiter, batch]
          exporters: [otlphttp]
        metrics:
          receivers: [otlp]
          processors: [memory_limiter, batch]
          exporters: [otlphttp]
        logs:
          receivers: [otlp]
          processors: [memory_limiter, batch]
          exporters: [otlphttp]
```

```yaml
# base/otel-collector/daemonset.yaml
apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: otel-collector
  namespace: observability
spec:
  selector:
    matchLabels:
      app: otel-collector
  template:
    metadata:
      labels:
        app: otel-collector
    spec:
      serviceAccountName: otel-collector
      containers:
        - name: collector
          image: otel/opentelemetry-collector-contrib:0.96.0
          args: ["--config", "/etc/otel/config.yaml"]
          ports:
            - containerPort: 4317
              name: otlp-grpc
            - containerPort: 4318
              name: otlp-http
          volumeMounts:
            - name: config
              mountPath: /etc/otel
      volumes:
        - name: config
          configMap:
            name: otel-collector-config
```

## Production Overlay

```yaml
# overlays/production/kustomization.yaml
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
resources:
  - ../../base/otel-collector
patches:
  - path: patches/resources.yaml
  - path: patches/config.yaml
```

```yaml
# overlays/production/patches/resources.yaml
apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: otel-collector
  namespace: observability
spec:
  template:
    spec:
      containers:
        - name: collector
          resources:
            limits:
              cpu: "2"
              memory: "4Gi"
            requests:
              cpu: "500m"
              memory: "1Gi"
```

## FluxCD Kustomization Resource

Tell Flux to reconcile the Collector configuration:

```yaml
# clusters/production/otel/kustomization.yaml
apiVersion: kustomize.toolkit.fluxcd.io/v1
kind: Kustomization
metadata:
  name: otel-collector
  namespace: flux-system
spec:
  interval: 5m
  retryInterval: 2m
  timeout: 3m
  sourceRef:
    kind: GitRepository
    name: flux-system
  path: ./overlays/production
  prune: true
  wait: true
  # Health checks to ensure the rollout succeeds
  healthChecks:
    - apiVersion: apps/v1
      kind: DaemonSet
      name: otel-collector
      namespace: observability
  # Send notifications on reconciliation events
  postBuild:
    substituteFrom:
      - kind: ConfigMap
        name: cluster-vars
```

## Automated Notifications

Set up Flux notifications so your team knows when configs change:

```yaml
# clusters/production/otel/notifications.yaml
apiVersion: notification.toolkit.fluxcd.io/v1
kind: Provider
metadata:
  name: slack
  namespace: flux-system
spec:
  type: slack
  channel: observability-deploys
  secretRef:
    name: slack-webhook-url
---
apiVersion: notification.toolkit.fluxcd.io/v1
kind: Alert
metadata:
  name: otel-collector-alerts
  namespace: flux-system
spec:
  providerRef:
    name: slack
  eventSeverity: info
  eventSources:
    - kind: Kustomization
      name: otel-collector
      namespace: flux-system
  exclusionList:
    - ".*no changes.*"
```

## Making a Configuration Change

The workflow is simple:

```bash
# 1. Edit the config on a branch
git checkout -b update-batch-size
# Edit overlays/production/patches/config.yaml

# 2. Commit and push
git add -A && git commit -m "Increase batch size to 8192"
git push origin update-batch-size

# 3. Open a PR, get review, merge to main

# 4. Flux detects the change within 5 minutes (the interval)
# and applies it automatically
flux get kustomizations --watch
```

## Monitoring Reconciliation

```bash
# Check the status of the reconciliation
flux get kustomizations

# View recent events
flux events --for Kustomization/otel-collector

# Force an immediate reconciliation
flux reconcile kustomization otel-collector
```

## Wrapping Up

FluxCD provides a pull-based GitOps model for managing OpenTelemetry Collector configurations. Every change goes through Git, gets reviewed in a PR, and is automatically applied to the cluster. The reconciliation loop ensures that the cluster state always matches what is in Git, and if someone manually changes something in the cluster, Flux will revert it on the next reconciliation cycle.
