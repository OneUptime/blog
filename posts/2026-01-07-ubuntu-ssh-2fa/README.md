# How to Set Up Two-Factor Authentication (2FA) for SSH on Ubuntu

Author: [nawazdhandala](https://github.com/nawazdhandala)

Tags: Ubuntu, Linux, SSH, Security, 2FA, Authentication

Description: Add two-factor authentication to SSH on Ubuntu using Google Authenticator PAM module for enhanced security.

---

## Introduction

In today's cybersecurity landscape, relying solely on passwords or even SSH keys is no longer sufficient to protect your servers from unauthorized access. Two-Factor Authentication (2FA) adds an essential layer of security by requiring users to provide two different types of credentials before gaining access. This guide will walk you through setting up 2FA for SSH on Ubuntu using the Google Authenticator PAM (Pluggable Authentication Module).

By the end of this tutorial, you will have a robust authentication system that combines something you know (password or SSH key) with something you have (a time-based one-time password from your mobile device).

## Understanding Two-Factor Authentication

### What is 2FA?

Two-Factor Authentication (2FA) is a security mechanism that requires users to verify their identity using two distinct factors:

1. **Something you know**: A password, PIN, or passphrase
2. **Something you have**: A physical device like a smartphone, hardware token, or security key
3. **Something you are**: Biometric data such as fingerprints or facial recognition

For SSH authentication, we typically combine the first two factors: your SSH key or password (something you know) with a Time-based One-Time Password (TOTP) generated by your smartphone (something you have).

### How TOTP Works

Time-based One-Time Passwords are generated using the TOTP algorithm defined in RFC 6238. Here's how it works:

1. A secret key is shared between the server and your authenticator app
2. Both the server and app use the current time (in 30-second intervals) and the secret key to generate a 6-digit code
3. The code changes every 30 seconds, making it useless if intercepted
4. The server validates the code by generating its own code and comparing them

### Benefits of 2FA for SSH

Implementing 2FA for SSH provides several security advantages:

- **Protection against password theft**: Even if an attacker obtains your password, they cannot access the server without the second factor
- **Defense against brute force attacks**: Time-limited codes make brute force attacks impractical
- **Compliance requirements**: Many security standards (PCI DSS, HIPAA, SOC 2) require multi-factor authentication
- **Audit trail**: Failed 2FA attempts are logged, helping detect unauthorized access attempts
- **Protection against keyloggers**: One-time codes are useless once used or expired

## Prerequisites

Before starting, ensure you have:

- Ubuntu 20.04, 22.04, or 24.04 server with root or sudo access
- SSH access to the server (preferably via SSH keys)
- A smartphone with an authenticator app installed (Google Authenticator, Authy, Microsoft Authenticator, or any TOTP-compatible app)
- A backup method of accessing the server (console access or another SSH session open) in case of configuration errors

**Important**: Keep an active SSH session open throughout this tutorial. This ensures you can recover if something goes wrong with the configuration.

## Installing Google Authenticator PAM Module

The first step is to install the Google Authenticator PAM module on your Ubuntu server.

### Update System Packages

Update your package list and upgrade existing packages to ensure system stability:

```bash
# Update the package list to get information about newest versions
sudo apt update

# Upgrade all installed packages to their latest versions
sudo apt upgrade -y
```

### Install the PAM Module

Install the libpam-google-authenticator package which provides the PAM module for TOTP authentication:

```bash
# Install the Google Authenticator PAM module
# This package provides both the PAM module and the google-authenticator setup utility
sudo apt install libpam-google-authenticator -y
```

### Verify Installation

Confirm that the installation was successful by checking the package status:

```bash
# Verify the package is installed correctly
dpkg -l | grep google-authenticator

# Check that the PAM module file exists
ls -la /lib/x86_64-linux-gnu/security/pam_google_authenticator.so
```

You should see output confirming the package is installed and the PAM module file exists.

## Configuring Google Authenticator for Your User

Each user who needs 2FA access must run the google-authenticator setup utility. This process generates the secret key and configuration for that user.

### Run the Setup Utility

Execute the google-authenticator command as the user who needs 2FA:

```bash
# Run the Google Authenticator setup utility
# This must be run as each user who needs 2FA access, not as root
google-authenticator
```

### Answer Configuration Questions

The utility will ask several questions. Here are the recommended answers for a secure setup:

```
Do you want authentication tokens to be time-based (y/n) y
```

This configures TOTP (Time-based One-Time Password) which is more secure than counter-based tokens.

After selecting yes, you'll see:

1. A QR code displayed in ASCII art
2. A secret key (backup this immediately)
3. Emergency scratch codes (backup these immediately)

**Save this information securely before continuing!**

```
Do you want me to update your "/home/username/.google_authenticator" file? (y/n) y
```

This saves the configuration to your home directory.

```
Do you want to disallow multiple uses of the same authentication
token? This restricts you to one login about every 30s, but it increases
your chances to notice or even prevent man-in-the-middle attacks (y/n) y
```

This prevents replay attacks where an attacker reuses an observed token.

```
By default, a new token is generated every 30 seconds by the mobile app.
In order to compensate for possible time-skew between the client and the server,
we allow an extra token before and after the current time. This allows for a
time skew of up to 30 seconds between authentication server and client. If you
experience problems with poor time synchronization, you can increase the window
from its default size of 3 permitted codes (one previous code, the current
code, the next code) to 17 permitted codes (the 8 previous codes, the current
code, and the 8 next codes). This will permit for a time skew of up to 4 minutes
between client and server.
Do you want to do so? (y/n) n
```

Keep the default window size unless you have time synchronization issues.

```
If the computer that you are logging into isn't hardened against brute-force
login attempts, you can enable rate-limiting for the authentication module.
By default, this limits attackers to no more than 3 login attempts every 30s.
Do you want to enable rate-limiting? (y/n) y
```

This provides additional protection against brute force attacks.

### Understanding the Configuration File

After setup, a `.google_authenticator` file is created in your home directory:

```bash
# View the configuration file (contains sensitive data - be careful)
# The file should only be readable by the owner
cat ~/.google_authenticator

# Verify proper file permissions
ls -la ~/.google_authenticator
```

The file contains:

- Line 1: Your secret key in base32 format
- Line 2+: Configuration options
- Remaining lines: Emergency scratch codes

### Secure the Configuration File

Ensure the configuration file has proper permissions:

```bash
# Set restrictive permissions on the configuration file
# Only the owner should be able to read and write this file
chmod 600 ~/.google_authenticator

# Verify the permissions are correct
ls -la ~/.google_authenticator
# Expected output: -rw------- 1 username username ...
```

## Setting Up TOTP on Mobile Devices

Now you need to add the secret to your authenticator app on your smartphone.

### Using the QR Code

The easiest method is to scan the QR code displayed during setup:

1. Open your authenticator app (Google Authenticator, Authy, Microsoft Authenticator, etc.)
2. Tap the "+" button or "Add account"
3. Select "Scan QR code"
4. Point your camera at the QR code displayed in the terminal

### Manual Entry

If you cannot scan the QR code, enter the secret key manually:

1. Open your authenticator app
2. Tap "+" then "Enter a setup key" or "Manual entry"
3. Enter an account name (e.g., "Ubuntu Server - username")
4. Enter the secret key shown during setup
5. Ensure "Time-based" is selected
6. Save the entry

### Verify the Setup

Before proceeding, verify that your authenticator app generates valid codes:

```bash
# Test that your authenticator code works with the pamtester utility
# First, install pamtester if not already present
sudo apt install pamtester -y

# Note: This test may not work until PAM is configured
# For now, just verify your app shows a 6-digit code that changes every 30 seconds
```

## Configuring PAM for SSH

PAM (Pluggable Authentication Modules) controls how authentication works on Linux systems. We need to configure PAM to use the Google Authenticator module for SSH.

### Backup Existing Configuration

Always backup configuration files before making changes:

```bash
# Create a backup of the SSH PAM configuration
sudo cp /etc/pam.d/sshd /etc/pam.d/sshd.backup

# Create a backup of the SSH daemon configuration
sudo cp /etc/ssh/sshd_config /etc/ssh/sshd_config.backup

# Verify backups were created
ls -la /etc/pam.d/sshd.backup /etc/ssh/sshd_config.backup
```

### Configure PAM for SSH

Edit the PAM configuration file for SSH:

```bash
# Open the SSH PAM configuration file
sudo nano /etc/pam.d/sshd
```

Add the following line at the end of the file:

```
# Enable Google Authenticator for two-factor authentication
# nullok allows users without 2FA configured to still log in (remove for strict enforcement)
auth required pam_google_authenticator.so nullok
```

**Understanding the options**:

- `auth required`: This is a required authentication step that must succeed
- `pam_google_authenticator.so`: The PAM module we installed
- `nullok`: Allows users without 2FA configured to log in with just password/key

For strict enforcement (all users must have 2FA):

```
# Strict mode - all users must have 2FA configured
auth required pam_google_authenticator.so
```

### Configure SSH Daemon

Edit the SSH daemon configuration:

```bash
# Open the SSH daemon configuration file
sudo nano /etc/ssh/sshd_config
```

Find and modify or add these lines:

```bash
# Enable challenge-response authentication (required for 2FA prompts)
KbdInteractiveAuthentication yes

# Note: On older Ubuntu versions (18.04 and earlier), use this instead:
# ChallengeResponseAuthentication yes

# Enable PAM authentication
UsePAM yes
```

### Save and Validate Configuration

After saving the files, validate the SSH configuration:

```bash
# Test the SSH configuration for syntax errors
# This command will report any configuration problems
sudo sshd -t

# If no output appears, the configuration is valid
# If errors appear, fix them before restarting SSH
```

### Restart SSH Service

Apply the changes by restarting the SSH service:

```bash
# Restart the SSH service to apply changes
sudo systemctl restart sshd

# Verify SSH is running correctly
sudo systemctl status sshd
```

**Warning**: Keep your current SSH session open and test with a new connection before closing it!

## Testing Your 2FA Configuration

### Open a New SSH Session

Open a new terminal window and attempt to SSH into your server:

```bash
# Connect to your server from a new terminal
# Replace 'username' and 'your-server-ip' with your actual values
ssh username@your-server-ip
```

### Expected Authentication Flow

You should see prompts similar to:

```
Password:
Verification code:
```

Enter your password first, then the 6-digit code from your authenticator app.

### Troubleshooting Connection Issues

If you cannot connect, use your existing SSH session to check logs:

```bash
# View recent authentication logs
sudo tail -50 /var/log/auth.log

# View SSH daemon logs specifically
sudo journalctl -u sshd -n 50

# Check for PAM-related errors
sudo grep -i pam /var/log/auth.log | tail -20
```

## Combining 2FA with SSH Keys

For maximum security, you can require both SSH key authentication and 2FA. This means an attacker would need your private key AND your phone to gain access.

### Configure SSH for Key + 2FA

Edit the SSH daemon configuration:

```bash
# Open SSH configuration
sudo nano /etc/ssh/sshd_config
```

Add or modify these settings:

```bash
# Require public key authentication
PubkeyAuthentication yes

# Disable password authentication for additional security
PasswordAuthentication no

# Specify required authentication methods
# This requires both publickey AND keyboard-interactive (2FA)
AuthenticationMethods publickey,keyboard-interactive
```

**Understanding AuthenticationMethods**:

- `publickey,keyboard-interactive`: Requires both SSH key AND 2FA code
- `publickey keyboard-interactive`: Requires either SSH key OR 2FA (less secure)
- `publickey,keyboard-interactive:pam`: More explicit PAM specification

### Update PAM Configuration for Key-Based Auth

When using SSH keys with 2FA, update the PAM configuration:

```bash
# Open PAM SSH configuration
sudo nano /etc/pam.d/sshd
```

Comment out the standard password authentication line if present:

```bash
# Comment out standard Unix authentication since we're using SSH keys
# @include common-auth
```

### Apply Changes

Restart SSH to apply the new configuration:

```bash
# Validate configuration before restarting
sudo sshd -t

# Restart SSH service
sudo systemctl restart sshd
```

### Test Key + 2FA Authentication

From a new terminal:

```bash
# Connect using your SSH key
# You should be prompted for the verification code but not the password
ssh -i ~/.ssh/your_private_key username@your-server-ip
```

## Managing Backup Codes

Backup codes (emergency scratch codes) are crucial for regaining access if you lose your phone.

### Storing Backup Codes Securely

During setup, you received 5 emergency scratch codes. Store these securely:

```bash
# View your current scratch codes (if needed)
# Each code can only be used once
head -n 10 ~/.google_authenticator
```

**Best practices for storing backup codes**:

1. **Password manager**: Store in a secure password manager like 1Password or Bitwarden
2. **Encrypted document**: Keep in an encrypted file on a separate device
3. **Physical copy**: Print and store in a secure location (safe, lockbox)
4. **Never store**: In plain text, in email, or in cloud storage without encryption

### Regenerating Backup Codes

If you've used your backup codes or suspect they're compromised:

```bash
# Regenerate your entire 2FA configuration including new backup codes
google-authenticator

# Or manually edit the file to add new scratch codes
# Each scratch code should be an 8-digit number
```

### Using a Backup Code

If you've lost your phone, you can use a scratch code instead of the TOTP:

```
Password: [your password]
Verification code: [8-digit scratch code]
```

After using a scratch code, it's automatically invalidated and removed from the configuration file.

## Advanced Configuration Options

### Per-User 2FA Settings

You can configure different 2FA settings for different users by editing their individual `.google_authenticator` files or using PAM conditions.

Create a group for users requiring 2FA:

```bash
# Create a group for 2FA users
sudo groupadd twofactor

# Add users to the group
sudo usermod -aG twofactor username

# Verify group membership
groups username
```

Modify PAM to only require 2FA for group members:

```bash
# Edit PAM SSH configuration
sudo nano /etc/pam.d/sshd
```

Add conditional 2FA based on group membership:

```
# Only require 2FA for members of the twofactor group
auth [success=1 default=ignore] pam_succeed_if.so user notingroup twofactor
auth required pam_google_authenticator.so
```

### Setting Up 2FA for the Root User

For root access, you should be especially careful:

```bash
# Switch to root and set up 2FA
sudo -i
google-authenticator

# Follow the same setup process as before
# This creates /root/.google_authenticator
```

### Allowing Fallback Authentication

For recovery scenarios, you might want to allow console access without 2FA:

```bash
# Edit PAM SSH configuration
sudo nano /etc/pam.d/sshd

# Add this line to skip 2FA for local console logins
auth [success=done default=ignore] pam_succeed_if.so service = sshd
```

### Time Synchronization

TOTP requires accurate time on both the server and your phone. Configure NTP:

```bash
# Install and configure NTP time synchronization
sudo apt install systemd-timesyncd -y

# Enable time synchronization
sudo timedatectl set-ntp true

# Verify time synchronization status
timedatectl status

# Check if NTP is active
timedatectl show --property=NTPSynchronized
```

## Troubleshooting Common Issues

### Issue: "Access Denied" After Entering Correct Code

Check time synchronization:

```bash
# Verify server time is correct
date

# Check NTP synchronization
timedatectl status

# Force time sync
sudo systemctl restart systemd-timesyncd
```

### Issue: No Verification Code Prompt

Verify PAM and SSH configuration:

```bash
# Check PAM configuration
sudo grep google /etc/pam.d/sshd

# Check SSH configuration
sudo grep -E "(KbdInteractive|ChallengeResponse|UsePAM)" /etc/ssh/sshd_config

# Ensure SSH service was restarted
sudo systemctl status sshd
```

### Issue: Users Without 2FA Cannot Log In

If `nullok` was not specified in PAM:

```bash
# Edit PAM configuration
sudo nano /etc/pam.d/sshd

# Ensure nullok is present if you want to allow non-2FA users
auth required pam_google_authenticator.so nullok
```

### Issue: Lost Phone and No Backup Codes

If you've lost access to your 2FA device and backup codes:

1. **Console access**: Use physical console or out-of-band management (IPMI, iLO, iDRAC)
2. **Recovery mode**: Boot into recovery mode if you have physical access
3. **Another admin**: Have another administrator with access help
4. **Cloud console**: Use provider's console access (AWS, GCP, Azure)

Once you have access:

```bash
# Remove the user's 2FA configuration
sudo rm /home/username/.google_authenticator

# Or reconfigure 2FA for the user
sudo -u username google-authenticator
```

### Issue: SELinux Blocking PAM Module

On systems with SELinux (less common on Ubuntu):

```bash
# Check for SELinux denials
sudo ausearch -m avc -ts recent

# Allow the PAM module if blocked
sudo setsebool -P authlogin_yubikey 1
```

### Viewing Detailed SSH Debug Output

For troubleshooting, enable verbose SSH logging:

```bash
# On the client side, use verbose mode
ssh -vvv username@your-server-ip

# On the server, temporarily increase logging
sudo nano /etc/ssh/sshd_config
# Add: LogLevel DEBUG3

# Restart SSH and check logs
sudo systemctl restart sshd
sudo tail -f /var/log/auth.log
```

## Security Best Practices

### Regular Security Audits

```bash
# Check for users with 2FA configured
for user in $(cut -d: -f1 /etc/passwd); do
    if [ -f "/home/$user/.google_authenticator" ]; then
        echo "2FA configured for: $user"
    fi
done

# Check 2FA file permissions
find /home -name ".google_authenticator" -exec ls -la {} \;
```

### Monitoring Authentication Attempts

```bash
# Monitor failed authentication attempts
sudo grep "Failed" /var/log/auth.log | tail -20

# Monitor successful 2FA authentications
sudo grep "Accepted" /var/log/auth.log | tail -20

# Set up log rotation for auth logs
sudo nano /etc/logrotate.d/rsyslog
```

### Regular Backup Code Rotation

Create a reminder system to rotate backup codes periodically:

```bash
# Script to check backup code status
#!/bin/bash
# Save as /usr/local/bin/check-2fa-codes.sh

GOOGLE_AUTH_FILE="$HOME/.google_authenticator"

if [ -f "$GOOGLE_AUTH_FILE" ]; then
    # Count remaining scratch codes (lines starting with 8 digits)
    CODES=$(grep -c "^[0-9]\{8\}$" "$GOOGLE_AUTH_FILE" 2>/dev/null || echo "0")
    echo "Remaining backup codes: $CODES"

    if [ "$CODES" -lt 3 ]; then
        echo "WARNING: Consider regenerating your 2FA configuration"
    fi
fi
```

### Protecting the Configuration File

Ensure proper security for the authenticator configuration:

```bash
# Set correct ownership
chown $USER:$USER ~/.google_authenticator

# Set restrictive permissions
chmod 600 ~/.google_authenticator

# Optionally make immutable (requires root to modify)
sudo chattr +i ~/.google_authenticator

# To remove immutable flag when needed
sudo chattr -i ~/.google_authenticator
```

## Automating 2FA Setup for Multiple Users

For organizations with many users, automate the 2FA setup:

```bash
#!/bin/bash
# Script to set up 2FA for a new user
# Save as /usr/local/bin/setup-user-2fa.sh

USERNAME=$1

if [ -z "$USERNAME" ]; then
    echo "Usage: $0 username"
    exit 1
fi

# Check if user exists
if ! id "$USERNAME" &>/dev/null; then
    echo "User $USERNAME does not exist"
    exit 1
fi

# Generate 2FA configuration non-interactively
sudo -u "$USERNAME" google-authenticator \
    --time-based \
    --disallow-reuse \
    --force \
    --rate-limit=3 \
    --rate-time=30 \
    --window-size=3 \
    --qr-mode=none

echo "2FA has been configured for $USERNAME"
echo "Secret key location: /home/$USERNAME/.google_authenticator"
echo "Please share the secret securely with the user"
```

### Extracting Secret for User Distribution

```bash
# Extract the secret key from a user's configuration
# This can be provided to the user to set up their authenticator app
sudo head -1 /home/username/.google_authenticator
```

## Conclusion

You have successfully configured Two-Factor Authentication for SSH on Ubuntu. Your server is now protected with an additional layer of security that requires both your SSH credentials and a time-based verification code from your mobile device.

### Key Takeaways

1. **Always have a backup access method** before making authentication changes
2. **Store backup codes securely** - they're your recovery mechanism
3. **Test thoroughly** in a new session before closing your working session
4. **Keep time synchronized** on both server and mobile device
5. **Consider combining SSH keys with 2FA** for maximum security

### Next Steps

- Set up 2FA for all administrative users
- Implement centralized authentication with LDAP/AD integration
- Consider hardware security keys (FIDO2/U2F) for even stronger security
- Set up monitoring and alerting for failed authentication attempts
- Document your recovery procedures

### Additional Resources

- [Google Authenticator PAM GitHub Repository](https://github.com/google/google-authenticator-libpam)
- [Ubuntu Security Documentation](https://ubuntu.com/security)
- [PAM Configuration Guide](https://www.linux.org/docs/man5/pam.conf.html)
- [RFC 6238 - TOTP Algorithm](https://tools.ietf.org/html/rfc6238)

Two-Factor Authentication is a critical component of a defense-in-depth security strategy. Combined with other security measures like fail2ban, proper firewall configuration, and regular security updates, 2FA significantly reduces the risk of unauthorized access to your systems.
