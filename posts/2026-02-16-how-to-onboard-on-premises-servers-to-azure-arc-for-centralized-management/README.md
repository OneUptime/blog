# How to Onboard On-Premises Servers to Azure Arc for Centralized Management

Author: [nawazdhandala](https://www.github.com/nawazdhandala)

Tags: Azure, Azure Arc, On-Premises, Hybrid Cloud, Server Management, Connected Machine Agent, Infrastructure

Description: Step-by-step guide to onboarding on-premises servers to Azure Arc so you can manage them alongside your cloud resources from the Azure Portal.

---

Running a hybrid environment means dealing with two different management planes - one for your cloud resources and one for your on-premises servers. Azure Arc bridges that gap by letting you project your on-premises servers (and servers in other clouds) into Azure as first-class resources. Once connected, you can manage them with Azure Policy, monitor them with Azure Monitor, and secure them with Microsoft Defender for Cloud, just like you would with native Azure VMs.

In this guide, I will walk through the full process of onboarding on-premises Windows and Linux servers to Azure Arc, including prerequisites, the agent installation, troubleshooting, and what to do after onboarding.

## What Happens When You Onboard a Server

When you onboard a server to Azure Arc, you install the Azure Connected Machine agent on it. This agent establishes an outbound connection to Azure (no inbound ports needed) and registers the server as a resource in your Azure subscription. The server shows up as a `Microsoft.HybridCompute/machines` resource type.

Once registered, the server gets a managed identity in Azure AD, which the agent uses for all communication. This identity also enables the server to authenticate to other Azure services, which is useful for scenarios like pulling secrets from Key Vault or authenticating to Azure SQL.

The agent does not give Azure control over the server in the traditional sense. Azure cannot start, stop, or reboot the server through Arc. Instead, Arc provides a management plane for configuration, monitoring, and governance. The actual server operations are still your responsibility.

## Prerequisites

Before you start, make sure you have these in place:

**Network requirements:**
- The server needs outbound HTTPS (port 443) access to several Azure endpoints
- If you use a proxy, the agent supports proxy configuration
- No inbound ports need to be opened

**Required Azure endpoints (the agent needs to reach these):**
- `management.azure.com` - Azure Resource Manager
- `login.microsoftonline.com` - Azure AD authentication
- `gbl.his.arc.azure.com` - Global hybrid identity service
- `*.his.arc.azure.com` - Regional hybrid identity service
- `*.guestconfiguration.azure.com` - Guest configuration

**Supported operating systems:**
- Windows Server 2012 R2 and newer
- Ubuntu 16.04, 18.04, 20.04, 22.04
- RHEL 7 and 8
- SLES 12 SP3+ and 15
- CentOS 7 and 8
- Amazon Linux 2
- Several other distributions (check the Microsoft docs for the full list)

**Azure permissions:**
- You need the Azure Connected Machine Onboarding role or Contributor role on the target resource group

## Method 1: Interactive Onboarding (Single Server)

For a single server or initial testing, the interactive method is the simplest.

### Step 1: Generate the Onboarding Script

In the Azure Portal, navigate to Azure Arc and click "Servers." Click "Add" and select "Add a single server." Fill in the details:

- Subscription and resource group where the server will be registered
- Region (should be close to the server's physical location)
- Operating system type
- Optional tags

The portal generates a script that you can download and run on the target server.

### Step 2: Run the Script on a Windows Server

Copy the generated script to your server and run it in an elevated PowerShell session:

```powershell
# Download and install the Connected Machine agent
# This script is generated by the Azure Portal
# It includes your specific subscription and resource group details

# Download the agent installer
Invoke-WebRequest -Uri "https://aka.ms/azcmagent-windows" `
    -OutFile "$env:TEMP\install_windows_azcmagent.ps1" `
    -UseBasicParsing

# Run the installer
& "$env:TEMP\install_windows_azcmagent.ps1"

# Connect the agent to Azure
# This opens a browser for interactive authentication
azcmagent connect `
    --resource-group "my-arc-servers-rg" `
    --tenant-id "your-tenant-id" `
    --location "eastus" `
    --subscription-id "your-subscription-id"
```

The `azcmagent connect` command will open a browser window for authentication. Log in with an account that has the Azure Connected Machine Onboarding role.

### Step 3: Run the Script on a Linux Server

For Linux, the process is similar:

```bash
# Download the agent package
wget https://aka.ms/azcmagent -O ~/install_linux_azcmagent.sh

# Install the agent
bash ~/install_linux_azcmagent.sh

# Connect to Azure (interactive auth via device code)
azcmagent connect \
    --resource-group "my-arc-servers-rg" \
    --tenant-id "your-tenant-id" \
    --location "eastus" \
    --subscription-id "your-subscription-id"
```

On Linux servers without a browser, the agent uses device code authentication. It will display a code and URL that you enter in a browser on another machine.

## Method 2: At-Scale Onboarding (Multiple Servers)

For onboarding dozens or hundreds of servers, interactive authentication does not scale. Instead, use a service principal.

### Create a Service Principal for Onboarding

```bash
# Create a service principal with the Connected Machine Onboarding role
az ad sp create-for-rbac \
    --name "ArcOnboardingSP" \
    --role "Azure Connected Machine Onboarding" \
    --scopes "/subscriptions/your-sub-id/resourceGroups/my-arc-servers-rg"
```

Save the appId, password, and tenant from the output. You will use these in your onboarding scripts.

### Scripted Onboarding with Service Principal

Here is a script you can deploy through your existing configuration management tool (Ansible, Puppet, SCCM, etc.):

```bash
#!/bin/bash
# Automated Azure Arc onboarding script
# Deploy this through your configuration management tool

# Variables - replace with your values
RESOURCE_GROUP="my-arc-servers-rg"
TENANT_ID="your-tenant-id"
SUBSCRIPTION_ID="your-subscription-id"
LOCATION="eastus"
SP_APP_ID="your-service-principal-app-id"
SP_SECRET="your-service-principal-secret"

# Install the agent if not already installed
if ! command -v azcmagent &> /dev/null; then
    wget https://aka.ms/azcmagent -O ~/install_linux_azcmagent.sh
    bash ~/install_linux_azcmagent.sh
fi

# Check if already connected
STATUS=$(azcmagent show --json 2>/dev/null | jq -r '.status' 2>/dev/null)
if [ "$STATUS" == "Connected" ]; then
    echo "Server is already connected to Azure Arc"
    exit 0
fi

# Connect using service principal (non-interactive)
azcmagent connect \
    --service-principal-id "$SP_APP_ID" \
    --service-principal-secret "$SP_SECRET" \
    --resource-group "$RESOURCE_GROUP" \
    --tenant-id "$TENANT_ID" \
    --location "$LOCATION" \
    --subscription-id "$SUBSCRIPTION_ID" \
    --tags "Environment=Production,Team=Infrastructure"
```

### Using Azure Automation for Onboarding

For Windows servers that are already managed by SCCM or Group Policy, you can deploy the agent and connection script as a software package or startup script. The key is using the service principal for authentication so no human interaction is required.

## Verifying the Onboarding

After onboarding, verify the connection from the server:

```bash
# Check the agent status
azcmagent show

# Expected output includes:
# Status: Connected
# Resource Name: your-server-name
# Resource Group: my-arc-servers-rg
# Subscription ID: your-subscription-id
```

In the Azure Portal, navigate to Azure Arc and then Servers. Your newly onboarded server should appear in the list. It may take a few minutes for the first heartbeat to register.

## Troubleshooting Common Issues

**Agent cannot reach Azure endpoints.** The most common problem. Run `azcmagent check` to test connectivity to all required endpoints. If you are behind a proxy, configure it with `azcmagent config set proxy.url http://proxy:port`.

**Authentication failures.** Make sure your service principal has the correct role assigned at the right scope. The Azure Connected Machine Onboarding role must be assigned on the resource group where servers will be registered.

**Agent is connected but shows as "Expired" in the portal.** This usually means the agent lost connectivity. Check network connectivity and ensure the agent service is running: `systemctl status himdsd` on Linux or check the "Azure Hybrid Instance Metadata Service" Windows service.

**Duplicate registrations.** If you reinstall the OS on a server and try to re-onboard it, you may get a conflict. Delete the old Arc resource in Azure first, then re-run the onboarding.

## Post-Onboarding Steps

Once your servers are onboarded, take advantage of the Azure management capabilities:

1. **Apply Azure Policy** to enforce configuration standards
2. **Enable Azure Monitor** to collect logs and metrics
3. **Deploy Microsoft Defender for Cloud** for security monitoring
4. **Install extensions** like the Log Analytics agent or custom script extensions
5. **Use tags** to organize servers by environment, team, or application

## Network Architecture Considerations

For production deployments, consider using Azure Arc Private Link Scope. This routes the agent's traffic through a private endpoint instead of the public internet, which is important for environments with strict network security requirements.

The Private Link Scope setup involves creating an Azure Private Link Scope resource, connecting it to a private endpoint in your VNet, and configuring your on-premises DNS to resolve the Azure endpoints to the private IP addresses.

## Summary

Onboarding on-premises servers to Azure Arc is a straightforward process that opens up a world of Azure management capabilities for your hybrid infrastructure. Start with interactive onboarding for testing, then move to service principal-based automation for scale. Once connected, your on-premises servers become first-class Azure resources that you can manage, monitor, and govern alongside your cloud workloads.
