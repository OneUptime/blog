# How to Use CDK Context for Configuration

Author: [nawazdhandala](https://github.com/nawazdhandala)

Tags: AWS, CDK, TypeScript, Configuration

Description: Learn how to use CDK context values for configuration management, including runtime lookups, cached context, and patterns for environment-specific settings.

---

CDK context is a key-value store that holds configuration data for your CDK app. It serves two purposes: it stores values you explicitly set (like environment names or feature flags), and it caches values that CDK looks up from AWS at synthesis time (like VPC IDs or AMI IDs).

Understanding context is important because it affects how your stacks synthesize and whether synthesis requires AWS access. Let's dig in.

## Setting Context Values

There are several ways to set context values, listed in order of precedence.

### Command Line

Pass context values with the `-c` or `--context` flag.

```bash
# Pass context values from the command line
cdk deploy -c environment=production -c region=us-west-2

# Multiple values
cdk synth -c feature_flags='{"newUi":true,"betaApi":false}'
```

### cdk.json

The `cdk.json` file holds project-level context that applies to every synthesis.

```json
{
  "app": "npx ts-node --prefer-ts-exts bin/app.ts",
  "context": {
    "environment": "dev",
    "project": "my-app",
    "vpcCidr": "10.0.0.0/16",
    "features": {
      "enableWaf": true,
      "enableCdn": false
    },
    "@aws-cdk/aws-lambda:recognizeLayerVersion": true,
    "@aws-cdk/core:stackRelativeExports": true
  }
}
```

### cdk.context.json

This file is auto-generated by CDK to cache AWS lookups. You should commit it to version control.

```json
{
  "availability-zones:account=111111111111:region=us-east-1": [
    "us-east-1a",
    "us-east-1b",
    "us-east-1c",
    "us-east-1d",
    "us-east-1e",
    "us-east-1f"
  ],
  "vpc-provider:account=111111111111:filter.vpc-id=vpc-12345:region=us-east-1": {
    "vpcId": "vpc-12345",
    "vpcCidrBlock": "10.0.0.0/16"
  }
}
```

## Reading Context Values

Access context values in your CDK code through the `node.tryGetContext` method.

```typescript
// Reading context values in a stack
export class MyStack extends cdk.Stack {
  constructor(scope: Construct, id: string, props?: cdk.StackProps) {
    super(scope, id, props);

    // Read a simple string value
    const environment = this.node.tryGetContext('environment') || 'dev';

    // Read a structured value
    const features = this.node.tryGetContext('features') || {};

    // Use context values to configure resources
    const bucket = new s3.Bucket(this, 'Bucket', {
      removalPolicy: environment === 'production'
        ? cdk.RemovalPolicy.RETAIN
        : cdk.RemovalPolicy.DESTROY,
    });

    // Conditional resource creation based on feature flags
    if (features.enableWaf) {
      // Create WAF resources
      new wafv2.CfnWebACL(this, 'WebAcl', {
        // ... WAF configuration
      });
    }
  }
}
```

## Context Lookups

CDK uses context for AWS resource lookups during synthesis. When you call methods like `Vpc.fromLookup()`, CDK queries AWS and caches the result in `cdk.context.json`.

```typescript
// Looking up an existing VPC by tag
const vpc = ec2.Vpc.fromLookup(this, 'Vpc', {
  vpcName: 'production-vpc',
});

// Looking up the latest AMI
const ami = ec2.MachineImage.lookup({
  name: 'my-golden-image-*',
  owners: ['self'],
});

// Looking up a hosted zone
const zone = route53.HostedZone.fromLookup(this, 'Zone', {
  domainName: 'example.com',
});

// Looking up an existing security group
const sg = ec2.SecurityGroup.fromLookupByName(
  this, 'SecurityGroup',
  'my-security-group',
  vpc,
);
```

The first time you run `cdk synth`, these lookups hit AWS APIs and the results get cached in `cdk.context.json`. Subsequent syntheses use the cached values, making them fast and deterministic.

## Managing the Context Cache

The cached context in `cdk.context.json` is critical for reproducible builds. Commit this file to version control.

```bash
# Clear all cached context (forces fresh lookups on next synth)
cdk context --clear

# Clear a specific cached value
cdk context --reset availability-zones:account=111111111111:region=us-east-1

# List all cached context values
cdk context
```

When should you clear the cache? When the underlying AWS resources change. If someone modifies the VPC you're looking up, the cached value becomes stale. Clear the specific entry and re-synthesize.

## Patterns for Environment Configuration

Here's a clean pattern for managing environment-specific configuration through context.

```typescript
// lib/config.ts - Centralized configuration using context
import * as cdk from 'aws-cdk-lib';
import { Construct } from 'constructs';

export interface AppConfig {
  environment: string;
  vpcCidr: string;
  instanceType: string;
  minCapacity: number;
  maxCapacity: number;
  domainName: string;
  enableAlarms: boolean;
  logRetentionDays: number;
}

const configurations: Record<string, AppConfig> = {
  dev: {
    environment: 'dev',
    vpcCidr: '10.0.0.0/16',
    instanceType: 't3.small',
    minCapacity: 1,
    maxCapacity: 2,
    domainName: 'dev.example.com',
    enableAlarms: false,
    logRetentionDays: 7,
  },
  staging: {
    environment: 'staging',
    vpcCidr: '10.1.0.0/16',
    instanceType: 't3.medium',
    minCapacity: 2,
    maxCapacity: 4,
    domainName: 'staging.example.com',
    enableAlarms: true,
    logRetentionDays: 30,
  },
  production: {
    environment: 'production',
    vpcCidr: '10.2.0.0/16',
    instanceType: 'r6g.large',
    minCapacity: 3,
    maxCapacity: 20,
    domainName: 'app.example.com',
    enableAlarms: true,
    logRetentionDays: 365,
  },
};

export function getConfig(scope: Construct): AppConfig {
  const env = scope.node.tryGetContext('environment') || 'dev';
  const config = configurations[env];

  if (!config) {
    throw new Error(`Unknown environment: ${env}. Valid options: ${Object.keys(configurations).join(', ')}`);
  }

  return config;
}
```

Use this config in your stacks.

```typescript
// lib/application-stack.ts
import { getConfig } from './config';

export class ApplicationStack extends cdk.Stack {
  constructor(scope: Construct, id: string, props?: cdk.StackProps) {
    super(scope, id, props);

    const config = getConfig(this);

    const vpc = new ec2.Vpc(this, 'Vpc', {
      ipAddresses: ec2.IpAddresses.cidr(config.vpcCidr),
      maxAzs: 3,
    });

    // Use config throughout the stack
    const service = new ecs.FargateService(this, 'Service', {
      // ...
      desiredCount: config.minCapacity,
    });
  }
}
```

Deploy different environments with the context flag.

```bash
# Deploy dev
cdk deploy -c environment=dev

# Deploy production
cdk deploy -c environment=production
```

## Context vs. Parameters vs. Environment Variables

CDK gives you several ways to pass configuration. Here's when to use each.

**Context** is best for values that affect synthesis - things like environment names, feature flags, and resource lookups. Context values are resolved at synthesis time.

**Stack parameters** (CloudFormation parameters) are resolved at deploy time. They're useful when you want to change values without re-synthesizing.

**Environment variables** work for CI/CD values like account IDs or build numbers that vary by pipeline execution.

```typescript
// Context - resolved at synthesis time
const env = this.node.tryGetContext('environment');

// CloudFormation parameter - resolved at deploy time
const param = new cdk.CfnParameter(this, 'InstanceType', {
  type: 'String',
  default: 't3.micro',
});

// Environment variable - resolved at synthesis time
const buildId = process.env.BUILD_ID || 'local';
```

The CDK team generally recommends context over CloudFormation parameters because context values are known at synthesis time, which enables better validation and type checking. Parameters create "unknown" values that CDK can't reason about during synthesis.

For more about managing configuration across multiple accounts, check out the post on [deploying CDK apps to multiple accounts](https://oneuptime.com/blog/post/deploy-cdk-apps-multiple-aws-accounts-regions/view). For understanding how context interacts with stacks, see [CDK stacks and environments](https://oneuptime.com/blog/post/cdk-stacks-and-environments/view).
